---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import InstallationCardCompact from '@/features/installations/components/InstallationCardCompact.astro';
import Button from '@/features/shared/Button.astro';
import EmptyState from '@/features/shared/EmptyState.astro';
import { getUser } from '../../../lib/page-utils';
import { getMyInstallations, type Installation } from '@/features/users/logic/installer-queries';
import type { InstallationStatus } from '../../../lib/supabase';

const user = getUser(Astro);
const accessToken = Astro.cookies.get('sb-access-token')?.value ?? '';

const url = Astro.url;
const statusFilter = url.searchParams.get('status') as InstallationStatus | null;

const installations = await getMyInstallations(
  accessToken,
  user.id,
  statusFilter ? { status: statusFilter } : undefined
);

function formatDateGroup(dateString: string): string {
  const date = new Date(dateString);
  const formatted = date.toLocaleDateString('es-ES', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  return formatted.charAt(0).toUpperCase() + formatted.slice(1);
}

function groupInstallationsByDate(installations: Installation[]): Map<string, Installation[]> {
  const grouped = new Map<string, Installation[]>();

  installations.forEach((installation) => {
    if (!installation.scheduled_date) {
      const key = 'Sin fecha';
      if (!grouped.has(key)) {
        grouped.set(key, []);
      }
      grouped.get(key)!.push(installation);
    } else {
      const dateKey = installation.scheduled_date.split('T')[0];
      if (!grouped.has(dateKey)) {
        grouped.set(dateKey, []);
      }
      grouped.get(dateKey)!.push(installation);
    }
  });

  const sortedMap = new Map(
    Array.from(grouped.entries()).sort((a, b) => {
      if (a[0] === 'Sin fecha') return 1;
      if (b[0] === 'Sin fecha') return -1;
      return a[0].localeCompare(b[0]);
    })
  );

  return sortedMap;
}

const groupedInstallations = groupInstallationsByDate(installations);
const pluralSuffix = installations.length !== 1 ? 'es' : '';

const statusFilters = [
  { value: null, label: 'Todas', icon: 'grid' },
  { value: 'pending', label: 'Pendientes', icon: 'clock' },
  { value: 'in_progress', label: 'En Progreso', icon: 'bolt' },
  { value: 'completed', label: 'Completadas', icon: 'check' },
  { value: 'cancelled', label: 'Canceladas', icon: 'x' }
];
---

<DashboardLayout title="Instalaciones" user={user}>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Instalaciones</h1>
    <p class="text-gray-600 mt-1">{installations.length} instalación{pluralSuffix}</p>
  </div>

  <div class="mb-6">
    <div class="flex flex-wrap gap-2">
      {
        statusFilters.map((filter) => {
          const isActive = filter.value === statusFilter;
          const href =
            filter.value === null
              ? '/installer/installations'
              : `/installer/installations?status=${filter.value}`;

          return (
            <a
              href={href}
              class={`inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                isActive
                  ? 'bg-primary-600 text-white shadow-md'
                  : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
              }`}
            >
              {filter.icon === 'grid' && (
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                  />
                </svg>
              )}
              {filter.icon === 'clock' && (
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              )}
              {filter.icon === 'bolt' && (
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              )}
              {filter.icon === 'check' && (
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              )}
              {filter.icon === 'x' && (
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              )}
              {filter.label}
            </a>
          );
        })
      }
    </div>
  </div>

  {
    installations.length === 0 ? (
      <EmptyState
        title={
          statusFilter
            ? 'No se encontraron instalaciones con este filtro'
            : 'No tienes instalaciones asignadas'
        }
        description={
          statusFilter
            ? 'Prueba con otro filtro para ver más resultados.'
            : 'Las nuevas instalaciones aparecerán aquí cuando sean asignadas.'
        }
      >
        {statusFilter && (
          <Button variant="primary" href="/installer/installations">
            Ver todas
          </Button>
        )}
      </EmptyState>
    ) : (
      <div class="space-y-8">
        {Array.from(groupedInstallations.entries()).map(([dateKey, installationsGroup]) => (
          <div>
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
              {dateKey === 'Sin fecha' ? 'Sin fecha programada' : formatDateGroup(dateKey)}
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {installationsGroup.map((installation) => (
                <InstallationCardCompact
                  installation={installation}
                  href={`/installer/installations/${installation.id}`}
                  showDate={false}
                />
              ))}
            </div>
          </div>
        ))}
      </div>
    )
  }
</DashboardLayout>
