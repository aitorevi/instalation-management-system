---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import Button from '../../../components/ui/Button.astro';
import StatusBadge from '../../../components/installations/StatusBadge.astro';
import Alert from '../../../components/ui/Alert.astro';
import { getUser } from '../../../lib/page-utils';
import { getMyInstallationById } from '../../../lib/queries/installer';
import { updateInstallation } from '../../../lib/actions/installations';

const user = getUser(Astro);
const accessToken = Astro.cookies.get('sb-access-token')?.value ?? '';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/installer/installations?error=invalid-id');
}

let successMessage: string | null = null;
let errorMessage: string | null = null;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const scheduled_date = formData.get('scheduled_date') as string;
  const scheduled_time = formData.get('scheduled_time') as string;

  if (scheduled_date && scheduled_time) {
    const dateTimeString = `${scheduled_date}T${scheduled_time}:00`;
    const result = await updateInstallation(accessToken, id, {
      scheduled_date: new Date(dateTimeString).toISOString()
    });

    if (result.success) {
      successMessage = 'Fecha y hora actualizadas correctamente';
    } else {
      errorMessage = result.error || 'Error al actualizar la fecha y hora';
    }
  } else if (!scheduled_time) {
    errorMessage = 'Debes especificar tanto la fecha como la hora';
  }
}

const installation = await getMyInstallationById(accessToken, user.id, id);

if (!installation) {
  return Astro.redirect('/installer/installations?error=not-found');
}

const scheduledDateValue = installation.scheduled_date
  ? new Date(installation.scheduled_date).toISOString().split('T')[0]
  : '';

const scheduledTimeValue = installation.scheduled_date
  ? new Date(installation.scheduled_date).toISOString().split('T')[1].substring(0, 5)
  : '';
---

<DashboardLayout title={installation.client_name} user={user}>
  <nav class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <a href="/installer/installations" class="text-primary-600 hover:text-primary-700">
          Instalaciones
        </a>
      </li>
      <li class="text-gray-400">/</li>
      <li class="text-gray-600">{installation.client_name}</li>
    </ol>
  </nav>

  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">{installation.client_name}</h1>
    <p class="text-gray-600 mt-1">{installation.installation_type}</p>
  </div>

  {
    successMessage && (
      <Alert variant="success" title="Éxito" class="mb-6" id="success-alert">
        {successMessage}
      </Alert>
    )
  }
  {
    errorMessage && (
      <Alert variant="error" title="Error" class="mb-6">
        {errorMessage}
      </Alert>
    )
  }

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Información del Cliente</h2>

    <div class="space-y-4">
      <div>
        <span class="text-sm font-medium text-gray-500">Cliente:</span>
        <p class="text-gray-900">{installation.client_name}</p>
      </div>

      <div>
        <span class="text-sm font-medium text-gray-500">Dirección:</span>
        <p class="text-gray-900">{installation.address}</p>
      </div>

      {
        installation.client_phone && (
          <div>
            <span class="text-sm font-medium text-gray-500">Teléfono:</span>
            <p class="text-gray-900">
              <a href={`tel:${installation.client_phone}`} class="text-primary-600 hover:underline">
                {installation.client_phone}
              </a>
            </p>
          </div>
        )
      }

      {
        installation.client_email && (
          <div>
            <span class="text-sm font-medium text-gray-500">Email:</span>
            <p class="text-gray-900">
              <a
                href={`mailto:${installation.client_email}`}
                class="text-primary-600 hover:underline"
              >
                {installation.client_email}
              </a>
            </p>
          </div>
        )
      }

      <div>
        <span class="text-sm font-medium text-gray-500">Estado:</span>
        <div class="mt-1">
          <StatusBadge status={installation.status} />
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Programación</h2>

    <form method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="scheduled_date" class="block text-sm font-medium text-gray-700 mb-2">
            Fecha programada
          </label>
          <input
            type="date"
            id="scheduled_date"
            name="scheduled_date"
            value={scheduledDateValue}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            required
          />
        </div>

        <div>
          <label for="scheduled_time" class="block text-sm font-medium text-gray-700 mb-2">
            Hora programada
          </label>
          <input
            type="time"
            id="scheduled_time"
            name="scheduled_time"
            value={scheduledTimeValue}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            required
          />
        </div>
      </div>

      <p class="text-sm text-gray-500">
        Coordina con el cliente la fecha y hora exacta de la instalación.
      </p>

      {
        installation.scheduled_date && (
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
              <strong>Programación actual:</strong>{' '}
              {new Date(installation.scheduled_date).toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              })}{' '}
              a las{' '}
              {new Date(installation.scheduled_date).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
              })}
            </p>
          </div>
        )
      }

      <div>
        <Button type="submit" variant="primary">Guardar fecha y hora</Button>
      </div>
    </form>
  </div>

  {
    installation.notes && (
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Notas</h2>
        <p class="text-gray-700 whitespace-pre-wrap">{installation.notes}</p>
      </div>
    )
  }

  <div class="flex gap-3">
    <Button variant="secondary" href="/installer/installations">Volver a Instalaciones</Button>
  </div>
</DashboardLayout>

<script>
  const successAlert = document.getElementById('success-alert');
  if (successAlert) {
    setTimeout(() => {
      successAlert.style.transition = 'opacity 0.5s ease-out';
      successAlert.style.opacity = '0';
      setTimeout(() => {
        successAlert.remove();
      }, 500);
    }, 5000);
  }
</script>
