---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import Button from '@/features/shared/Button.astro';
import StatusBadge from '@/features/installations/components/StatusBadge.astro';
import Toast from '@/features/shared/Toast.astro';
import Modal from '@/features/shared/Modal.astro';
import { getUser } from '../../../lib/page-utils';
import { getMyInstallationById } from '@/features/users/logic/installer-queries';
import { updateInstallation } from '@/features/installations/logic/mutations';

const user = getUser(Astro);
const accessToken = Astro.cookies.get('sb-access-token')?.value ?? '';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/installer/installations?error=invalid-id');
}

let successMessage: string | null = null;
let errorMessage: string | null = null;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('_action') as string;

  if (action === 'complete') {
    const result = await updateInstallation(accessToken, id, {
      status: 'completed',
      completed_at: new Date().toISOString()
    });

    if (result.success) {
      successMessage = 'Instalación marcada como completada correctamente';
    } else {
      errorMessage = result.error || 'Error al completar la instalación';
    }
  } else {
    const scheduled_date = formData.get('scheduled_date') as string;
    const scheduled_time = formData.get('scheduled_time') as string;

    if (scheduled_date && scheduled_time) {
      const dateTimeString = `${scheduled_date}T${scheduled_time}:00`;

      const currentInstallation = await getMyInstallationById(accessToken, user.id, id);
      const updateData: any = {
        scheduled_date: new Date(dateTimeString).toISOString()
      };

      if (currentInstallation?.status === 'pending') {
        updateData.status = 'in_progress';
      }

      const result = await updateInstallation(accessToken, id, updateData);

      if (result.success) {
        successMessage =
          currentInstallation?.status === 'pending'
            ? 'Fecha programada y estado actualizado a "En Progreso"'
            : 'Fecha y hora actualizadas correctamente';
      } else {
        errorMessage = result.error || 'Error al actualizar la fecha y hora';
      }
    } else if (!scheduled_time) {
      errorMessage = 'Debes especificar tanto la fecha como la hora';
    }
  }
}

const installation = await getMyInstallationById(accessToken, user.id, id);

if (!installation) {
  return Astro.redirect('/installer/installations?error=not-found');
}

function toLocalDateString(dateString: string): string {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function toLocalTimeString(dateString: string): string {
  const date = new Date(dateString);
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

const scheduledDateValue = installation.scheduled_date
  ? toLocalDateString(installation.scheduled_date)
  : '';

const scheduledTimeValue = installation.scheduled_date
  ? toLocalTimeString(installation.scheduled_date)
  : '';
---

<DashboardLayout title={installation.client_name} user={user}>
  <nav class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <a href="/installer/installations" class="text-primary-600 hover:text-primary-700">
          Instalaciones
        </a>
      </li>
      <li class="text-gray-400">/</li>
      <li class="text-gray-600">{installation.client_name}</li>
    </ol>
  </nav>

  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">{installation.client_name}</h1>
    <p class="text-gray-600 mt-1">Material: {installation.installation_type}</p>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Información del Cliente</h2>

    <div class="space-y-4">
      <div>
        <span class="text-sm font-medium text-gray-500">Cliente:</span>
        <p class="text-gray-900">{installation.client_name}</p>
      </div>

      <div>
        <span class="text-sm font-medium text-gray-500">Dirección:</span>
        <p class="text-gray-900">{installation.address}</p>
      </div>

      {
        installation.client_phone && (
          <div>
            <span class="text-sm font-medium text-gray-500">Teléfono:</span>
            <p class="text-gray-900">
              <a href={`tel:${installation.client_phone}`} class="text-primary-600 hover:underline">
                {installation.client_phone}
              </a>
            </p>
          </div>
        )
      }

      {
        installation.client_email && (
          <div>
            <span class="text-sm font-medium text-gray-500">Email:</span>
            <p class="text-gray-900">
              <a
                href={`mailto:${installation.client_email}`}
                class="text-primary-600 hover:underline"
              >
                {installation.client_email}
              </a>
            </p>
          </div>
        )
      }

      <div>
        <span class="text-sm font-medium text-gray-500">Estado:</span>
        <div class="mt-1">
          <StatusBadge status={installation.status} />
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Programación</h2>

    <form method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="scheduled_date" class="block text-sm font-medium text-gray-700 mb-2">
            Fecha programada
          </label>
          <input
            type="date"
            id="scheduled_date"
            name="scheduled_date"
            value={scheduledDateValue}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            required
          />
        </div>

        <div>
          <label for="scheduled_time" class="block text-sm font-medium text-gray-700 mb-2">
            Hora programada
          </label>
          <input
            type="time"
            id="scheduled_time"
            name="scheduled_time"
            value={scheduledTimeValue}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            required
          />
        </div>
      </div>

      <p class="text-sm text-gray-500">
        Coordina con el cliente la fecha y hora exacta de la instalación.
      </p>

      {
        installation.scheduled_date && (
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
              <strong>Programación actual:</strong>{' '}
              {new Date(installation.scheduled_date).toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              })}{' '}
              a las{' '}
              {new Date(installation.scheduled_date).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
              })}
            </p>
          </div>
        )
      }

      <div>
        <Button type="submit" variant="primary">Guardar fecha y hora</Button>
      </div>
    </form>
  </div>

  {
    installation.notes && (
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Notas</h2>
        <p class="text-gray-700 whitespace-pre-wrap">{installation.notes}</p>
      </div>
    )
  }

  <div class="flex gap-3">
    {
      installation.status === 'in_progress' && (
        <Button variant="primary" onclick="openCompleteModal()">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          Marcar como Completada
        </Button>
      )
    }
    <Button variant="secondary" href="/installer/installations">Volver a Instalaciones</Button>
  </div>

  {
    installation.status === 'in_progress' && (
      <Modal id="complete" title="Completar Instalación">
        <p class="text-gray-700">
          ¿Estás seguro de que quieres marcar esta instalación como completada?
        </p>
        <p class="text-sm text-gray-500 mt-2">
          Esta acción indicará que el trabajo ha sido finalizado exitosamente.
        </p>

        <Fragment slot="footer">
          <Button variant="secondary" onclick="closeCompleteModal()">
            Cancelar
          </Button>
          <form method="POST" style="display: inline;">
            <input type="hidden" name="_action" value="complete" />
            <Button type="submit" variant="primary">
              Confirmar Completada
            </Button>
          </form>
        </Fragment>
      </Modal>
    )
  }

  {successMessage && <Toast variant="success" message={successMessage} />}
  {errorMessage && <Toast variant="error" message={errorMessage} duration={0} />}
</DashboardLayout>
