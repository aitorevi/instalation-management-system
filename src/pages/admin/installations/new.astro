---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import InstallationForm from '@/features/installations/components/InstallationForm.astro';
import Toast from '@/features/shared/Toast.astro';
import { getUser } from '../../../lib/page-utils';
import { getInstallers } from '@/features/users/logic/queries';
import { createInstallation } from '@/features/installations/logic/mutations';

const user = getUser(Astro);
const accessToken = Astro.cookies.get('sb-access-token')?.value || '';

const installers = await getInstallers(accessToken);

let error: string | null = null;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const scheduled_date = formData.get('scheduled_date') as string;

  const data = {
    client_name: formData.get('client_name') as string,
    client_phone: formData.get('client_phone') as string,
    client_email: formData.get('client_email') as string,
    address: formData.get('address') as string,
    installation_type: formData.get('installation_type') as string,
    scheduled_date: scheduled_date ? new Date(scheduled_date).toISOString() : null,
    assigned_to: (formData.get('assigned_to') as string) || null,
    notes: (formData.get('notes') as string) || null,
    created_by: user.id
  };

  const result = await createInstallation(accessToken, data);

  if (result.success) {
    return Astro.redirect('/admin/installations');
  } else {
    error = result.error || 'Error al crear la instalaci贸n';
  }
}
---

<DashboardLayout title="Nueva Instalaci贸n" user={user}>
  <nav class="mb-6">
    <ol class="flex items-center gap-2 text-sm text-gray-500">
      <li><a href="/admin" class="hover:text-gray-700">Dashboard</a></li>
      <li>/</li>
      <li><a href="/admin/installations" class="hover:text-gray-700">Instalaciones</a></li>
      <li>/</li>
      <li class="text-gray-900">Nueva</li>
    </ol>
  </nav>

  <h1 class="text-2xl font-bold text-gray-900 mb-6">Nueva Instalaci贸n</h1>

  <InstallationForm
    installers={installers}
    action="/admin/installations/new"
    submitLabel="Crear Instalaci贸n"
  />

  {error && <Toast variant="error" message={error} duration={0} />}
</DashboardLayout>
